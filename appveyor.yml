version: 7.9.0.0.{build}
image: Visual Studio 2015

branches:
  only:
    - latestw_all
    - hotfix
init:
  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

build_script:
  - ps: |
      Import-Module $env:APPVEYOR_BUILD_FOLDER\contrib\win32\openssh\AppveyorHelper.psm1
      Invoke-AppVeyorBuild

after_build:
  - ps: |
      Import-Module $env:APPVEYOR_BUILD_FOLDER\contrib\win32\openssh\AppveyorHelper.psm1
      Install-Pester
      $arch = $env:PROCESSOR_ARCHITECTURE
      if($arch -eq 'amd64') { $foldername = $arch = "x64" } else {$foldername = "win32"}
      $lib = "$env:APPVEYOR_BUILD_FOLDER\bin\$foldername\Release\libcrypto.dll"
      if(-not (Test-path $lib)) { Copy-Item $env:APPVEYOR_BUILD_FOLDER\contrib\win32\openssh\LibreSSL\bin\desktop\$arch\libcrypto.dll $env:APPVEYOR_BUILD_FOLDER\bin\$foldername\Release\ -Force }

test_script:
  - ps: |
      Import-Module $env:APPVEYOR_BUILD_FOLDER\contrib\win32\openssh\AppveyorHelper.psm1
      Invoke-OpenSSHTests

after_test:
  - ps: |
      Import-Module $env:APPVEYOR_BUILD_FOLDER\contrib\win32\openssh\AppveyorHelper.psm1
      Publish-OpenSSHTestResults

on_finish:
  - ps: |
      $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
      Import-Module $env:APPVEYOR_BUILD_FOLDER\contrib\win32\openssh\AppveyorHelper.psm1
      Publish-Artifact